<div class="cart-container">
    <div class="header">
        <h2>Carrito de Cotizaciones</h2>
        <div class="cart-summary" *ngIf="cart.length > 0">
            <span class="total-items">{{ getTotalItems() }} items</span>
            <span class="total-price">${{ getTotalPrice().toFixed(2) }}</span>
        </div>
    </div>

    <!-- Mensaje de error -->
    <div class="alert alert-danger" *ngIf="error">
        <i class="fas fa-exclamation-triangle"></i>
        {{ error }}
    </div>

    <!-- Formulario para agregar nueva cotización -->
    <div class="add-item-form" *ngIf="currentUserId">
        <h3>Agregar Nueva Cotización</h3>

        <form (ngSubmit)="addToCart()" #itemForm="ngForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="product_id">Producto *</label>
                    <select id="product_id" name="product_id" [(ngModel)]="newItem.product_id" required
                        class="form-control">
                        <option value="0">Seleccionar producto...</option>
                        <option value="1">Ventana PVC</option>
                        <option value="2">Puerta PVC</option>
                        <option value="3">Ventana Aluminio</option>
                        <option value="4">Puerta Aluminio</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="model">Modelo *</label>
                    <input type="text" id="model" name="model" [(ngModel)]="newItem.model" required
                        placeholder="Ej: Corrediza, Batiente, etc." class="form-control">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="height">Alto (m) *</label>
                    <input type="number" id="height" name="height" [(ngModel)]="newItem.height" required min="0.1"
                        step="0.01" placeholder="1.50" (input)="calculateTotalPrice()" class="form-control">
                </div>

                <div class="form-group">
                    <label for="width">Ancho (m) *</label>
                    <input type="number" id="width" name="width" [(ngModel)]="newItem.width" required min="0.1"
                        step="0.01" placeholder="1.20" (input)="calculateTotalPrice()" class="form-control">
                </div>

                <div class="form-group">
                    <label for="quantity">Cantidad *</label>
                    <input type="number" id="quantity" name="quantity" [(ngModel)]="newItem.quantity" required min="1"
                        (input)="calculateTotalPrice()" class="form-control">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Precio Total</label>
                    <div class="price-display">${{ newItem.precio_total.toFixed(2) }}</div>
                </div>
            </div>

            <button type="submit" [disabled]="!itemForm.form.valid || isLoading" class="btn btn-primary">
                <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
                <i class="fas fa-plus" *ngIf="!isLoading"></i>
                {{ isLoading ? 'Agregando...' : 'Agregar al Carrito' }}
            </button>
        </form>
    </div>

    <!-- Lista del carrito -->
    <div class="cart-items" *ngIf="cart.length > 0; else emptyCart">
        <h3>Cotizaciones en el Carrito</h3>

        <div class="cart-item" *ngFor="let item of cart; trackBy: trackByCartId">
            <div class="item-info">
                <div class="item-header">
                    <h4>{{ getProductName(item.product_id) }}</h4>
                    <span class="item-model">{{ item.model }}</span>
                </div>

                <div class="item-details">
                    <div class="dimensions">
                        <span class="dimension">{{ item.height }}m (alto)</span>
                        <span class="dimension">{{ item.width }}m (ancho)</span>
                        <span class="area">Área: {{ (parseFloatSafe(item.height) *
                            parseFloatSafe(item.width)).toFixed(2) }}m²</span>
                    </div>
                </div>

                <div class="item-controls">
                    <div class="quantity-control">
                        <button type="button" (click)="updateQuantity(item.ccart_id, item.quantity - 1)"
                            [disabled]="item.quantity <= 1" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-minus"></i>
                        </button>

                        <span class="quantity">{{ item.quantity }}</span>

                        <button type="button" (click)="updateQuantity(item.ccart_id, item.quantity + 1)"
                            class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <div class="item-price">
                        <span class="price">${{ item.precio_total.toFixed(2) }}</span>
                    </div>

                    <button type="button" (click)="removeItem(item.ccart_id)" class="btn btn-sm btn-danger remove-btn"
                        title="Eliminar cotización">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Acciones del carrito -->
        <div class="cart-actions">
            <button type="button" (click)="clearCart()" class="btn btn-outline-danger">
                <i class="fas fa-trash-alt"></i>
                Limpiar Carrito
            </button>

            <button type="button" class="btn btn-success">
                <i class="fas fa-paper-plane"></i>
                Enviar Cotización
            </button>
        </div>
    </div>

    <!-- Estado vacío -->
    <ng-template #emptyCart>
        <div class="empty-cart" *ngIf="!isLoading && currentUserId">
            <i class="fas fa-shopping-cart empty-icon"></i>
            <h3>Tu carrito está vacío</h3>
            <p>Agrega algunas cotizaciones para comenzar</p>
        </div>
    </ng-template>

    <!-- Loading state -->
    <div class="loading" *ngIf="isLoading && cart.length === 0">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Cargando carrito...</span>
    </div>
</div>